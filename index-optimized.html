<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Viewer - Optimized</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: 0.1em;
            animation: pulse 1.5s ease-in-out infinite;
            text-align: center;
            max-width: 80%;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 50px;
            color: white;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: none;
            user-select: none;
        }

        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            max-width: 80%;
        }

        .error h2 {
            font-weight: 300;
            margin-bottom: 1rem;
        }

        .error p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .file-selector {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 50px;
            color: white;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .file-selector select {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            margin-left: 10px;
        }

        .file-selector option {
            background: #333;
            color: white;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="file-selector">
            <label>3D Model:</label>
            <select id="model-selector">
                <option value="test-cube.stl">Test Cube (Fast)</option>
                <option value="Example.stl">Full Model (153MB - Slow)</option>
            </select>
        </div>
        
        <div id="canvas-container"></div>
        <div class="loading" id="loading">Select a model to load...</div>
        <div class="controls" id="controls" style="display: none;">
            Drag to rotate • Scroll to zoom • Right-click to pan
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/STLLoader.js"></script>
    <script>
        let scene, camera, renderer, controls, model;
        const container = document.getElementById('canvas-container');
        const loading = document.getElementById('loading');
        const controlsInfo = document.getElementById('controls');
        const modelSelector = document.getElementById('model-selector');

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = null;

            // Camera setup
            camera = new THREE.PerspectiveCamera(
                45,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 50, 100);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // Controls setup
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 30;
            controls.maxDistance = 300;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 2;

            // Lighting setup
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.3);
            directionalLight2.position.set(-50, 50, -50);
            scene.add(directionalLight2);

            // Handle window resize
            window.addEventListener('resize', onWindowResize, false);

            // Stop auto-rotation on user interaction
            controls.addEventListener('start', () => {
                controls.autoRotate = false;
            });

            // Model selector change
            modelSelector.addEventListener('change', loadSelectedModel);
        }

        function loadSelectedModel() {
            const selectedFile = modelSelector.value;
            loadSTL(selectedFile);
        }

        function loadSTL(filename) {
            // Clear existing model
            if (model) {
                scene.remove(model);
                model = null;
            }

            loading.style.display = 'block';
            controlsInfo.style.display = 'none';
            
            if (filename === 'Example.stl') {
                loading.innerHTML = `
                    <div style="text-align: center;">
                        <h2>⚠️ Large File Warning</h2>
                        <p>This is a 153MB file</p>
                        <p>Loading may take several minutes...</p>
                        <p>Consider using the Test Cube for faster loading</p>
                        <div style="margin-top: 20px;">
                            <button onclick="modelSelector.value='test-cube.stl'; loadSelectedModel();" 
                                    style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                Use Test Cube Instead
                            </button>
                        </div>
                    </div>
                `;
                
                // Auto-load after 3 seconds if user doesn't cancel
                setTimeout(() => {
                    if (modelSelector.value === 'Example.stl') {
                        actuallyLoadSTL(filename);
                    }
                }, 3000);
            } else {
                actuallyLoadSTL(filename);
            }
        }

        function actuallyLoadSTL(filename) {
            const loader = new THREE.STLLoader();
            
            console.log(`Loading: ${filename}`);
            loading.innerHTML = `Loading ${filename}...`;
            
            loader.load(
                filename,
                function (geometry) {
                    console.log(`STL file loaded successfully! (${filename})`, geometry);
                    
                    // Center the geometry
                    geometry.center();

                    // Calculate bounding box for proper scaling
                    const boundingBox = new THREE.Box3().setFromObject(new THREE.Mesh(geometry));
                    const size = boundingBox.getSize(new THREE.Vector3());
                    const maxDimension = Math.max(size.x, size.y, size.z);
                    const scale = 50 / maxDimension;

                    // Create material
                    const material = new THREE.MeshPhongMaterial({
                        color: 0xffffff,
                        specular: 0x111111,
                        shininess: 200,
                        side: THREE.DoubleSide
                    });

                    // Create mesh
                    model = new THREE.Mesh(geometry, material);
                    model.scale.set(scale, scale, scale);
                    model.castShadow = true;
                    model.receiveShadow = true;

                    scene.add(model);

                    // Hide loading, show controls
                    loading.style.display = 'none';
                    controlsInfo.style.display = 'block';

                    // Start animation
                    animate();
                },
                function (xhr) {
                    const percentComplete = (xhr.loaded / xhr.total) * 100;
                    if (!isNaN(percentComplete)) {
                        loading.innerHTML = `Loading ${filename}... ${Math.round(percentComplete)}%`;
                        console.log(`Loading progress: ${Math.round(percentComplete)}%`);
                    }
                },
                function (error) {
                    console.error(`Error loading ${filename}:`, error);
                    loading.innerHTML = `
                        <div class="error">
                            <h2>Unable to load 3D model</h2>
                            <p>Error: ${error.message || 'Unknown error'}</p>
                            <p>Check browser console for details.</p>
                        </div>
                    `;
                }
            );
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // Initialize the scene
        init();
    </script>
</body>
</html>
